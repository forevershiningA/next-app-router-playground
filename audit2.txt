Audit Report: SvgHeadstone.tsx
Overview
The SvgHeadstone component is responsible for generating 3D geometry from an SVG path, applying textures, and managing the coordinate system for child elements (inscriptions, motifs).

Findings
1. Unused Prop: inscriptions
Location: Line 48 (Type), Line 114 (Destructuring).
Issue: The inscriptions prop is defined and destructured but never used within the component.
Impact: If the parent component expects SvgHeadstone to render inscriptions or pass them to children, this is not happening. If inscriptions are rendered via the children render prop (e.g. <SvgHeadstone ...>{(api) => <Inscriptions ... />}</SvgHeadstone>), then passing inscriptions to SvgHeadstone itself is redundant.
Recommendation: Remove the inscriptions prop if it is not needed, or implement its usage if SvgHeadstone is supposed to manage them directly.
2. Child API vs. Render Hierarchy Discrepancy
Location: Line 416 (childApi.group) vs Line 452 (Children Wrapper).
Issue:
childApi.group returns groupRef, which refers to the outer <group>. This group has no scale applied (scale is 1,1,1).
The children render prop is executed inside an inner <group> (Line 452) which has scale={meshScale}.
Impact:
Components rendered via standard JSX (returned by children) will inherit meshScale and align correctly with the headstone.
Components that use api.group to manually attach objects (e.g., using portal or direct Three.js manipulation) will attach to the unscaled outer group. This could lead to size mismatches if they expect to be in the same scaled space as the headstone mesh.
Recommendation:
If api.group is intended to be the "mounting point" for additions, it should probably refer to the inner group (the one with meshScale), or the documentation should clarify that api.group is World Space (mostly) and children need to handle their own scaling.
Given that meshScale handles the SVG-to-World conversion and aspect ratio fitting (sCore), it is likely that children should inherit this scale.
3. Memory Management (Geometry Disposal)
Location: Line 142 (useMemo creating geometries).
Issue: Geometries created via new THREE.ExtrudeGeometry inside useMemo are not explicitly disposed when the component unmounts or when dependencies change (regenerating geometry).
Impact: Potential memory leak with frequent updates.
Recommendation: Add a useEffect to dispose of the generated geometries when they are replaced or when the component unmounts.
4. Coordinate System & Normalization
Status: Correct.
Analysis:
The code explicitly normalizes the geometry to a Y-Up system:
Centers X.
Translates Y so the visual bottom is at 0.
Flips Y (scale(1, -1, 1)) so +Y is up.
Fixes winding order to maintain correct normals.
This aligns with standard 3D practices and the project's recent coordinate system fixes.
5. Texture Mapping
Status: Correct.
Analysis:
The UV mapping logic correctly handles the Y-flip by mapping 3D Y back to SVG Y space for the side texture wrapping (
nearestS
).
Cap mapping is standard planar mapping.
6. Texture Cloning Side Effects
Location: Line 125 (useMemo cloning textures), Line 370 (useLayoutEffect updating repeats).
Analysis: The code clones textures to allow independent repeat settings per headstone instance. This is a good practice to avoid shared material side effects. The useLayoutEffect correctly updates the repeat values based on the calculated dimensions.
Action Plan
Remove Unused Prop: Delete inscriptions from Props and destructuring.
Fix Memory Leak: Implement geometry disposal.
Clarify/Fix API Group: Decide if api.group should point to the inner wrapper. (For now, I will leave it as is unless requested, but note it. Actually, usually ref on the component returns the top level group, which is standard. api.group returning the same is consistent. The children being inside a scaled group is a React-tree detail. If a child uses api.group, they are "breaking out" of the React tree hierarchy slightly, so they might want the unscaled parent. However, for "sticking" things to the stone, the scaled group is better. I will add a wrapper to the API).
