The screenshot shows two main issues:

Extreme Blur: The Depth of Field is too aggressive and the focus plane is too narrow (macro effect), making the headstone text unreadable.

Jagged Edges (Aliasing): The text and edges of the stone are pixelated because adding <EffectComposer> automatically disables the default Anti-Aliasing (MSAA) of the canvas.

Here is the fixed Scene.tsx.

Key Changes

Added multisampling={8} to EffectComposer: This restores Anti-Aliasing, making the text and gold edges crisp again.

Fixed DepthOfField:

Added worldFocusRange={1.5}: This creates a "safe zone" of 1.5 meters around the target where everything stays perfectly sharp.

Reduced bokehScale to 2: Makes the background blur softer and less distracting.

Adjusted target to [0, 0.8, 0]: Centers the focus slightly lower on the bulk of the stone.

code
Tsx
download
content_copy
expand_less
--- START OF FILE Scene.tsx ---

'use client';
import { OrbitControls, Environment, ContactShadows, useTexture, Sparkles } from '@react-three/drei';
import { EffectComposer, DepthOfField, Vignette } from '@react-three/postprocessing';
import * as THREE from 'three';
import HeadstoneAssembly from './headstone/HeadstoneAssembly';
import AtmosphericSky from './AtmosphericSky';
import { useHeadstoneStore } from '#/lib/headstone-store';

import { useFrame } from '@react-three/fiber';
import { useRef, Suspense } from 'react';

// --- CONFIGURATION ---
// Darkened green slightly for a more "lush" look, less neon
const GRASS_COLOR = '#1a591a';

function GrassFloor() {
  // Load grass textures from local public folder
  const props = useTexture({
    map: '/textures/grass_color.jpg',
    normalMap: '/textures/grass_normal.jpg',
    roughnessMap: '/textures/grass_roughness.jpg',
    aoMap: '/textures/grass_ao.jpg',
  });

  // FIX: Reduce tiling to hide the grid pattern
  // 6 or 8 is usually the sweet spot for this scale
  props.map.repeat.set(6, 6);
  props.normalMap.repeat.set(6, 6);
  props.roughnessMap.repeat.set(6, 6);
  props.aoMap.repeat.set(6, 6);

  // Apply wrapping to all textures
  [props.map, props.normalMap, props.roughnessMap, props.aoMap].forEach((tex) => {
    tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
  });

  return (
    <group position={[0, -0.01, 0]}>
      <mesh rotation={[-Math.PI / 2, 0, 0]} receiveShadow>
        {/* Increase size to push horizon further back */}
        <planeGeometry args={[150, 150]} />
        <meshStandardMaterial 
          {...props}
          color={GRASS_COLOR}
          roughness={1}     // Grass isn't shiny
          metalness={0}
          envMapIntensity={0} // Grass shouldn't reflect the sky too much
        />
      </mesh>
      
      {/* Soften the contact shadow */}
      <ContactShadows
        position={[0, 0.01, 0]}
        scale={20}
        blur={2.5}
        opacity={0.6}
        far={10}
        color="#000000"
      />
    </group>
  );
}

// Fallback if internet is slow/textures fail
function SimpleGrassFloor() {
  return (
    <group position={[0, -0.01, 0]}>
      <mesh rotation={[-Math.PI / 2, 0, 0]} receiveShadow>
        <planeGeometry args={[150, 150]} />
        <meshStandardMaterial color={GRASS_COLOR} roughness={1} />
      </mesh>
      <ContactShadows position={[0, 0.01, 0]} scale={20} blur={2.5} opacity={0.6} color="#000000" />
    </group>
  );
}

export default function Scene({ 
  targetRotation = 0,
  currentRotation
}: { 
  targetRotation?: number;
  currentRotation?: React.MutableRefObject<number>;
}) {
  const groupRef = useRef<THREE.Group>(null);
  const is2DMode = useHeadstoneStore((s) => s.is2DMode);
  const baseSwapping = useHeadstoneStore((s) => s.baseSwapping);
  const setSelected = useHeadstoneStore((s) => s.setSelected);
  const setEditingObject = useHeadstoneStore((s) => s.setEditingObject);
  const setSelectedInscriptionId = useHeadstoneStore((s) => s.setSelectedInscriptionId);
  const setSelectedAdditionId = useHeadstoneStore((s) => s.setSelectedAdditionId);
  const setSelectedMotifId = useHeadstoneStore((s) => s.setSelectedMotifId);

  // Smooth rotation animation
  useFrame(() => {
    if (groupRef.current && currentRotation) {
      const diff = targetRotation - currentRotation.current;
      const delta = diff * 0.1; // Lerp factor (adjust for speed)
      
      if (Math.abs(diff) > 0.001) {
        currentRotation.current += delta;
        groupRef.current.rotation.y = currentRotation.current;
      }
    }
  });

  const handleCanvasClick = (e: any) => {
    // Only deselect if clicking on empty space (not on any 3D object)
    if (e.eventObject === e.object) {
      setSelected(null);
      setEditingObject('headstone');
      setSelectedInscriptionId(null);
      setSelectedAdditionId(null);
      setSelectedMotifId(null);
    }
  };

  return (
    <>
      {is2DMode && <color attach="background" args={['#CFE8FC']} />}
      
      {/* Fog: Keep it subtle to hide the floor edge */}
      {!is2DMode && <fog attach="fog" args={['#e0f2fe', 15, 50]} />}
      
      {/* Invisible background plane to capture clicks */}
      <mesh
        position={[0, 0, -5]}
        onClick={handleCanvasClick}
      >
        <planeGeometry args={[100, 100]} />
        <meshBasicMaterial transparent opacity={0} />
      </mesh>
      
      {/* Daytime Sky with White Clouds */}
      {!is2DMode && <AtmosphericSky />}
      
      {/* Subtle dust motes (white for daytime) */}
      {!is2DMode && (
         <Sparkles 
           count={40}
           scale={10}
           size={2}
           speed={0.4}
           opacity={0.3}
           color="#fff"
           position={[0, 2, 0]}
         />
      )}
      
      {/* --- LIGHTING IMPROVEMENTS --- */}
      <ambientLight intensity={0.3} color="#cce0ff" />
      
      <spotLight 
        color="#fff5e6"
        intensity={3.0}
        angle={0.5}
        penumbra={1}
        position={[-2, 5, 6]}
        castShadow
        shadow-bias={-0.0001}
      />

      {/* Fill Light: Softens the dark side of the black granite */}
      <pointLight position={[5, 2, 5]} intensity={0.5} color="#b8c5d1" />

      {/* Rim Light: Highlights the serpentine top edge */}
      <spotLight color="#bfdbfe" intensity={2.0} position={[-5, 4, -5]} />

      <Environment
        preset="city"
        environmentIntensity={0.8}
        background={false}
        environmentRotation={[0, Math.PI / 2, 0]} 
      />

      <group ref={groupRef}>
        <HeadstoneAssembly />
      </group>
      
      {/* TEXTURED FLOOR with fallback for slow connections */}
      <Suspense fallback={<SimpleGrassFloor />}>
        <GrassFloor />
      </Suspense>

      {/* --- POST PROCESSING FIX --- */}
      {/* 
          CRITICAL FIX: multisampling={8} restores Anti-Aliasing (removing jagged text).
          disableNormalPass improves performance since we aren't using SSAO.
      */}
      {!is2DMode && (
        <EffectComposer multisampling={8} disableNormalPass>
          <DepthOfField 
            target={[0, 0.8, 0]}  // Focus slightly lower (center of stone)
            focalLength={0.02}    // Keep lens wide
            bokehScale={2}        // Reduced from 3 to 2 for softer, less aggressive blur
            height={700}
            worldFocusRange={1.5} // CRITICAL: Keeps everything within 1.5m of target SHARP
          />
          <Vignette offset={0.3} darkness={0.4} />
        </EffectComposer>
      )}

      <OrbitControls
        makeDefault
        enabled={!baseSwapping}
        enableDamping={true}
        dampingFactor={baseSwapping ? 0 : 0.05}
        enableRotate={!is2DMode}
        enableZoom={!is2DMode}
        enablePan={!is2DMode}
        rotateSpeed={0.5}
        zoomSpeed={0.8}
        panSpeed={0.8}
        minPolarAngle={Math.PI / 3.5}
        maxPolarAngle={Math.PI / 2 - 0.05}
      />
    </>
  );
}